var glob = require('glob');
var path = require('path');

var re = /(?:<script.*?src=|<link.*?href=)(?:'|").\/(.*?)(?:'|")/;

module.exports = function(grunt) {
    var desc = 'Replace glob asset references with expanded tags.';

    grunt.registerMultiTask('glob', desc, function() {
        this.files.forEach(function(file) {
            var body = grunt.file.read(file.src[0]).split(/\r?\n/),
                lines = [];

            body.forEach(function(line) {
                var match = line.match(re);

                if (match) {
                    var opts = {
                        cwd: path.dirname(file.dest)
                    };

                    glob.sync(match[1], opts).forEach(function(asset) {
                        lines.push(line.replace(match[1], asset));
                    });
                } else {
                    lines.push(line);
                }
            });

            grunt.file.write(file.dest, lines.join('\n'));
        });
    });
};
